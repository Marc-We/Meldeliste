<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meldeliste – Lehrer</title>
  <style>
    :root {
      --bg: #06070c;
      --panel: #0f1524;
      --card: #10192f;
      --muted: #7a8499;
      --text: #e9eeff;
      --accent: #36c38c;
      --accent-strong: #2ecc71;
      --toilet: #9b59b6;
      --line: #1f2943;
      --danger: #f45b69;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(120% 80% at 15% 10%, #1b2b57, #06070c 55%);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      color: var(--text);
      min-height: 100vh;
      padding: 28px;
    }
    h1 { margin: 0 0 8px; }
    h2 { margin: 0 0 10px; font-size: 19px; }
    label { display: block; margin-top: 10px; color: var(--muted); font-size: 14px; }
    input {
      width: 100%; margin-top: 6px; padding: 11px 12px;
      border-radius: 10px; border: 1px solid #24304c; background: #0c1424; color: var(--text);
      font-size: 15px;
    }
    button {
      padding: 11px 14px; border: none; border-radius: 10px;
      font-weight: 700; font-size: 14px; cursor: pointer;
      transition: transform 0.08s ease, filter 0.12s ease;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    button:hover:not(:disabled) { transform: translateY(-1px); filter: brightness(1.05); }
    .primary { background: var(--accent); color: #06110b; }
    .ghost { background: transparent; color: var(--text); border: 1px solid #2b3652; }
    .danger { background: var(--danger); color: #fff; }
    .layout { max-width: 1200px; margin: 0 auto; display: grid; gap: 16px; }
    .panel { background: var(--panel); border: 1px solid var(--line); border-radius: 14px; padding: 16px; box-shadow: 0 16px 48px rgba(0,0,0,0.35); }
    .status {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 12px; border-radius: 999px; border: 1px solid var(--line);
      background: rgba(255,255,255,0.04); font-weight: 600; font-size: 14px;
    }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--danger); }
    .dot.ok { background: var(--accent); box-shadow: 0 0 10px rgba(54,195,140,0.6); }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; border: 1px solid #27324f; background: rgba(255,255,255,0.03); font-size: 13px; }
    .room-list { display: grid; gap: 10px; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); }
    .room-card { background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 12px; display: grid; gap: 8px; }
    .room-card h3 { margin: 0; }
    .room-card .meta { color: var(--muted); font-size: 13px; }
    .board { background: var(--card); border: 1px solid var(--line); border-radius: 12px; overflow: hidden; }
    .member-row { display: grid; grid-template-columns: 34px 1fr 240px; align-items: center; padding: 10px 12px; border-bottom: 1px solid #1b2340; gap: 8px; }
    .lamp { width: 14px; height: 14px; border-radius: 50%; background: #555d70; }
    .lamp.on { background: var(--accent-strong); box-shadow: 0 0 12px rgba(46,204,113,0.7); }
    .lamp.toilet { background: var(--toilet); box-shadow: 0 0 12px rgba(155,89,182,0.7); }
    .meta-line { color: var(--muted); font-size: 12px; }
    .ratings button { padding: 6px 8px; font-size: 12px; border-radius: 8px; }
    .log { max-height: 260px; overflow: auto; }
    .log table { width: 100%; border-collapse: collapse; font-size: 14px; color: var(--text); }
    .log th, .log td { padding: 8px 6px; border-bottom: 1px solid #1c2440; text-align: left; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(210px, 1fr)); gap: 12px; }
    .stat-card { background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 10px; }
    .stat-card h4 { margin: 0 0 4px; }
    .small { font-size: 12px; color: var(--muted); }
    .poll { display: grid; gap: 8px; }
    .poll input[type="text"], .poll textarea { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #24304c; background: #0c1424; color: var(--text); }
    .poll .options { display: grid; gap: 6px; }
    .poll .option { display: flex; align-items: center; gap: 6px; }
    .cloud { display: flex; flex-wrap: wrap; gap: 8px; }
    .cloud .word { background: rgba(255,255,255,0.05); padding: 6px 10px; border-radius: 10px; }
    .homework-card { background: var(--card); border: 1px solid var(--line); border-radius: 10px; padding: 10px; margin-top: 8px; }
    .questions { max-height: 240px; overflow: auto; }
    .q-item { padding: 8px 10px; border-bottom: 1px solid #1b2340; }
    .q-time { color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
  <div class="layout">
    <div class="row" style="justify-content: space-between;">
      <div>
        <h1>Lehrer-Dashboard</h1>
        <div class="meta-line">Räume verwalten, Meldungen sehen, bewerten</div>
      </div>
      <div class="status"><div class="dot" id="dot"></div><span id="connText">Verbinde...</span></div>
    </div>

    <div class="panel">
      <h2>Profil</h2>
      <div class="row">
        <label style="width:140px">
          Anrede
          <select id="salutation">
            <option value="Herr">Herr</option>
            <option value="Frau">Frau</option>
          </select>
        </label>
        <label style="flex:1">
          Nachname
          <input id="lastName" placeholder="Ihr Nachname">
        </label>
        <label style="width:180px">
          Passwort
          <input id="password" type="password" placeholder="Passwort">
        </label>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="saveProfile" class="ghost">Profil speichern</button>
        <div class="pill" id="profileInfo">Noch kein Profil gespeichert</div>
      </div>
      <div class="row" style="margin-top:6px">
        <button id="modeRegister" class="ghost" style="flex:1">Registrieren</button>
        <button id="modeLogin" class="ghost" style="flex:1">Anmelden</button>
        <button id="logout" class="ghost" style="flex:1">Profil löschen</button>
      </div>
      <div class="pill" id="authStatus"></div>
    </div>

    <div class="panel">
      <h2>Räume</h2>
      <div class="row">
        <input id="roomName" placeholder="Neuer Raumname" style="flex:1">
        <select id="roomClass" style="width:160px">
          <option value="">Klasse wählen</option>
        </select>
        <select id="roomSubject" style="width:160px">
          <option value="">Fach wählen</option>
        </select>
        <button id="createRoom" class="primary">Raum erstellen</button>
      </div>
      <div class="room-list" id="roomList"></div>
    </div>

    <div class="panel" id="catalogPanel" style="display:none">
      <h2>Kataloge (nur Admin)</h2>
      <div class="row">
        <input id="newClass" placeholder="Neue Klasse (z. B. 10A)" style="flex:1">
        <button id="addClass" class="ghost">Klasse anlegen</button>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="newSubject" placeholder="Neues Fach (z. B. Mathe)" style="flex:1">
        <button id="addSubject" class="ghost">Fach anlegen</button>
      </div>
      <div class="pill" id="catalogInfo">Keine Daten geladen</div>
    </div>

    <div class="panel" id="teachingsPanel" style="display:none">
      <h2>Meine Klassen/Fächer</h2>
      <div class="row">
        <select id="teachClass" style="flex:1">
          <option value="">Klasse wählen</option>
        </select>
        <select id="teachSubject" style="flex:1">
          <option value="">Fach wählen</option>
        </select>
        <button id="addTeaching" class="primary">Hinzufügen</button>
      </div>
      <div class="stats-grid" id="teachingsList"></div>
    </div>

    <div class="panel">
      <h2>Umfragen</h2>
      <div class="poll">
        <input id="pollQuestion" type="text" placeholder="Frage">
        <div class="options">
          <input id="pollOptions" type="text" placeholder="Optionen, getrennt durch ;">
        </div>
        <label><input id="pollMultiple" type="checkbox"> Mehrfachauswahl erlauben</label>
        <div class="row">
          <button id="createPoll" class="primary">Umfrage senden</button>
        </div>
      </div>
      <div class="questions" id="pollResults"><div class="small">Keine aktive Umfrage</div></div>
    </div>

    <div class="panel">
      <h2>Umfrage-Templates</h2>
      <div class="poll">
        <input id="tmplQuestion" type="text" placeholder="Frage">
        <input id="tmplOptions" type="text" placeholder="Optionen, getrennt durch ;">
        <label><input id="tmplMultiple" type="checkbox"> Mehrfachauswahl erlauben</label>
        <div class="row">
          <button id="createTemplate" class="ghost">Template speichern</button>
        </div>
      </div>
      <div class="questions" id="templateList"><div class="small">Keine Templates</div></div>
    </div>

    <div class="panel">
      <h2>Gedankenrunde</h2>
      <div class="row" style="margin-bottom:8px">
        <button id="startThoughts" class="primary">Freischalten</button>
        <button id="endThoughts" class="danger">Beenden</button>
      </div>
      <div class="cloud" id="thoughtsCloud"><div class="small">Keine Daten</div></div>
    </div>

    <div class="panel">
      <div class="row" style="justify-content: space-between; align-items: center;">
        <h2>Aktueller Raum</h2>
        <div class="row">
          <div class="pill" id="currentRoomInfo">Kein Raum ausgewählt</div>
          <button id="closeRoom" class="danger" disabled>Raum schließen</button>
        </div>
      </div>
      <div class="board" id="membersBoard"></div>
    </div>

    <div class="panel" id="questionBanner" style="display:none">
      <h2>Aktuelle Frage</h2>
      <div id="questionBannerText" class="q-item"></div>
      <button id="questionClose" class="ghost" style="margin-top:8px">Schließen</button>
    </div>

    <div class="panel">
      <h2>Protokoll</h2>
      <div class="log" id="logBox"><div class="small">Noch keine Einträge</div></div>
    </div>

    <div class="panel">
      <h2>Fragen (anonym)</h2>
      <div class="questions" id="questionsBox"><div class="small">Keine Fragen</div></div>
    </div>

    <div class="panel">
      <h2>Statistiken (Raum)</h2>
      <div class="stats-grid" id="statsGrid"></div>
    </div>
  </div>

  <script>
    const host = location.hostname || 'localhost';
    const WS_URL = `${location.protocol === 'https:' ? 'wss' : 'ws'}://${host}:3000`;

    const dot = document.getElementById('dot');
    const connText = document.getElementById('connText');
    const salutationInput = document.getElementById('salutation');
    const lastNameInput = document.getElementById('lastName');
    const passwordInput = document.getElementById('password');
    const saveProfileBtn = document.getElementById('saveProfile');
    const profileInfo = document.getElementById('profileInfo');
    const modeRegisterBtn = document.getElementById('modeRegister');
    const modeLoginBtn = document.getElementById('modeLogin');
    const logoutBtn = document.getElementById('logout');
    const authStatus = document.getElementById('authStatus');
    const roomNameInput = document.getElementById('roomName');
    const roomClassInput = document.getElementById('roomClass');
    const roomSubjectInput = document.getElementById('roomSubject');
    const createRoomBtn = document.getElementById('createRoom');
    const roomListEl = document.getElementById('roomList');
    const currentRoomInfo = document.getElementById('currentRoomInfo');
    const closeRoomBtn = document.getElementById('closeRoom');
    const membersBoard = document.getElementById('membersBoard');
    const logBox = document.getElementById('logBox');
    const statsGrid = document.getElementById('statsGrid');
    const questionsBox = document.getElementById('questionsBox');
    const questionBanner = document.getElementById('questionBanner');
    const questionBannerText = document.getElementById('questionBannerText');
    const questionClose = document.getElementById('questionClose');
    const catalogPanel = document.getElementById('catalogPanel');
    const newClassInput = document.getElementById('newClass');
    const newSubjectInput = document.getElementById('newSubject');
    const addClassBtn = document.getElementById('addClass');
    const addSubjectBtn = document.getElementById('addSubject');
    const catalogInfo = document.getElementById('catalogInfo');
    const teachingsPanel = document.getElementById('teachingsPanel');
    const teachClassSelect = document.getElementById('teachClass');
    const teachSubjectSelect = document.getElementById('teachSubject');
    const addTeachingBtn = document.getElementById('addTeaching');
    const teachingsList = document.getElementById('teachingsList');
    const pollQuestionInput = document.getElementById('pollQuestion');
    const pollOptionsInput = document.getElementById('pollOptions');
    const pollMultipleInput = document.getElementById('pollMultiple');
    const createPollBtn = document.getElementById('createPoll');
    const pollResultsBox = document.getElementById('pollResults');
    const startThoughtsBtn = document.getElementById('startThoughts');
    const endThoughtsBtn = document.getElementById('endThoughts');
    const thoughtsCloud = document.getElementById('thoughtsCloud');
    const homeworkPanel = document.createElement('div');
    homeworkPanel.className = 'panel';
    homeworkPanel.innerHTML = '<h2>Hausaufgaben</h2><div id="homeworkList"><div class="small">Keine Hausaufgaben</div></div><div class="row" style="margin-top:8px;"><input id="homeworkText" style="flex:1" placeholder="Hausaufgabe für diesen Raum"><button id="sendHomework" class="primary">Senden</button></div>';
    document.querySelector('.layout').appendChild(homeworkPanel);
    const homeworkList = homeworkPanel.querySelector('#homeworkList');
    const homeworkText = homeworkPanel.querySelector('#homeworkText');
    const sendHomeworkBtn = homeworkPanel.querySelector('#sendHomework');
    const tmplQuestionInput = document.getElementById('tmplQuestion');
    const tmplOptionsInput = document.getElementById('tmplOptions');
    const tmplMultipleInput = document.getElementById('tmplMultiple');
    const createTemplateBtn = document.getElementById('createTemplate');
    const templateListBox = document.getElementById('templateList');
    const rosterBox = document.getElementById('rosterBox');

    let ws = null;
    let profile = { role: 'teacher', userId: null, salutation: 'Herr', lastName: '', password: '' };
    let authMode = 'register';
    let rooms = [];
    let currentRoom = null;
    let presence = new Map(); // userId -> {ready, name, online}
    let logEntries = [];
    let stats = [];
    let classCatalog = [];
    let subjectCatalog = [];
    const toiletStates = new Map(); // userId -> {status,start}
    let questions = [];
    let poll = null;
    let thoughts = [];
    let homeworkItems = [];
    let templates = [];
    let roster = [];

    function setConnection(ok) {
      dot.classList.toggle('ok', ok);
      connText.textContent = ok ? 'Verbunden' : 'Getrennt';
    }

    function renderProfileInfo() {
      if (!profile.userId) {
        profileInfo.textContent = 'Noch kein Profil gespeichert';
      } else {
        profileInfo.textContent = `Eingeloggt als ${profile.salutation || ''} ${profile.lastName || ''}`.trim();
      }
      authStatus.textContent = authMode === 'register' ? 'Registrierungsmodus' : 'Anmeldemodus';
      modeRegisterBtn.classList.toggle('primary', authMode === 'register');
      modeLoginBtn.classList.toggle('primary', authMode === 'login');
      modeRegisterBtn.classList.toggle('ghost', authMode !== 'register');
      modeLoginBtn.classList.toggle('ghost', authMode !== 'login');

      // Admin-sicht auf Kataloge
      const isAdmin = profile.role === 'admin';
      catalogPanel.style.display = isAdmin ? 'block' : 'none';
      teachingsPanel.style.display = (profile.role === 'teacher' || profile.role === 'admin') ? 'block' : 'none';
    }

    function formatDuration(startMs) {
      if (!startMs) return '0:00';
      const diff = Math.max(0, Date.now() - startMs);
      const sec = Math.round(diff / 1000);
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${m}:${s.toString().padStart(2, '0')}`;
    }

    function renderRooms() {
      roomListEl.innerHTML = '';
      if (!rooms.length) {
        roomListEl.innerHTML = '<div class="small">Keine Räume vorhanden</div>';
        return;
      }
      rooms.forEach((room) => {
        const card = document.createElement('div');
        card.className = 'room-card';
        card.innerHTML = `
          <div class="row" style="justify-content: space-between; align-items: center;">
            <h3>${room.name}</h3>
            <div class="pill">${room.active === false ? 'geschlossen' : 'aktiv'}</div>
          </div>
          <div class="meta">Klasse: ${room.className || '-'}</div>
          <div class="row">
            <button class="ghost" data-join="${room.id}" ${room.active === false ? 'disabled' : ''}>Öffnen</button>
            <button class="danger" data-close="${room.id}" ${room.active === false ? 'disabled' : ''}>Schließen</button>
          </div>
        `;
        roomListEl.appendChild(card);
      });

      roomListEl.querySelectorAll('[data-join]').forEach((btn) => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-join');
          currentRoom = id;
          sendJoin(id);
          renderCurrentRoom();
        };
      });
      roomListEl.querySelectorAll('[data-close]').forEach((btn) => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-close');
          if (!ws || ws.readyState !== WebSocket.OPEN) return;
          ws.send(JSON.stringify({ type: 'roomClose', roomId: id }));
          if (currentRoom === id) {
            currentRoom = null;
            renderCurrentRoom();
          }
        };
      });
    }

    function renderCatalogs() {
      const cls = classCatalog.length ? classCatalog.join(', ') : 'Keine Klassen';
      const subs = subjectCatalog.length ? subjectCatalog.join(', ') : 'Keine Fächer';
      catalogInfo.textContent = `Klassen: ${cls} | Fächer: ${subs}`;

      const fillSelect = (el, data, label) => {
        const prev = el.value;
        el.innerHTML = `<option value="">${label}</option>`;
        data.forEach((item) => {
          const opt = document.createElement('option');
          opt.value = item;
          opt.textContent = item;
          el.appendChild(opt);
        });
        if (prev && data.includes(prev)) el.value = prev;
      };
      fillSelect(roomClassInput, classCatalog, 'Klasse wählen');
      fillSelect(roomSubjectInput, subjectCatalog, 'Fach wählen');
      fillSelect(teachClassSelect, classCatalog, 'Klasse wählen');
      fillSelect(teachSubjectSelect, subjectCatalog, 'Fach wählen');
    }

    function renderTeachings() {
      const list = Array.isArray(profile.teachings) ? profile.teachings : [];
      if (!list.length) {
        teachingsList.innerHTML = '<div class="small">Keine Einträge</div>';
        return;
      }
      teachingsList.innerHTML = list.map(t => `
        <div class="stat-card">
          <h4>${t.className}</h4>
          <div class="small">${t.subject}</div>
        </div>
      `).join('');
    }

    function renderCurrentRoom() {
      const room = rooms.find(r => r.id === currentRoom);
      if (!room) {
        currentRoomInfo.textContent = 'Kein Raum ausgewählt';
        closeRoomBtn.disabled = true;
        membersBoard.innerHTML = '';
        logBox.innerHTML = '<div class="small">Noch keine Einträge</div>';
        statsGrid.innerHTML = '';
        return;
      }
      currentRoomInfo.textContent = `${room.name} (Klasse ${room.className || '-'})`;
      closeRoomBtn.disabled = room.active === false;
      renderMembers();
      renderLog();
      renderStats();
    }

    function renderMembers() {
      const room = rooms.find(r => r.id === currentRoom);
      if (!room) {
        membersBoard.innerHTML = '';
        return;
      }
      const members = Array.from(presence.values()).filter(m => m.role !== 'teacher' && m.role !== 'admin');
      if (!members.length) {
        membersBoard.innerHTML = '<div class="small" style="padding:10px;">Noch keine Teilnehmer</div>';
        return;
      }
      const rows = members.map(m => `
        <div class="member-row">
          <div class="lamp ${m.ready ? 'on' : ''} ${toiletStates.get(m.userId)?.status ? 'toilet' : ''} ${m.important ? 'toilet' : ''}" style="${m.important ? 'background:#e74c3c; box-shadow:0 0 12px rgba(231,76,60,0.7);' : ''}"></div>
          <div>
            <div>${m.name}</div>
            <div class="meta-line">${m.online ? 'online' : 'offline'}${m.ready ? ' · bereit' : ''}</div>
          </div>
          <div class="ratings" data-user="${m.userId}">
            <button data-call="only">Aufrufen</button>
            ${['--','-','0','+','++'].map(r => `<button data-rating="${r}">${r}</button>`).join(' ')}
            ${toiletStates.get(m.userId)?.status === 'pending' ? '<button data-allow="toilet">Erlauben</button>' : ''}
            ${toiletStates.get(m.userId)?.status === 'allowed' ? `<span class="small">Toilette seit ${formatDuration(toiletStates.get(m.userId)?.start)}</span>` : ''}
            ${m.important ? '<button data-important="clear">Wichtig erledigt</button>' : ''}
          </div>
        </div>
      `).join('');
      membersBoard.innerHTML = rows;

      membersBoard.querySelectorAll('.ratings button').forEach((btn) => {
        btn.onclick = () => {
          const userId = btn.parentElement.getAttribute('data-user');
          const ratingAttr = btn.getAttribute('data-rating');
          const isCallOnly = btn.getAttribute('data-call') === 'only';
          const isAllowToilet = btn.getAttribute('data-allow') === 'toilet';
          const impAction = btn.getAttribute('data-important');
          if (!currentRoom || !ws || ws.readyState !== WebSocket.OPEN) return;

          if (isCallOnly) {
            ws.send(JSON.stringify({ type: 'ack', roomId: currentRoom, userId }));
            return;
          }
          if (isAllowToilet) {
            ws.send(JSON.stringify({ type: 'toiletAllow', roomId: currentRoom, userId }));
            return;
          }
          if (impAction === 'clear') {
            ws.send(JSON.stringify({ type: 'importantClear', roomId: currentRoom, userId }));
            return;
          }
          if (impAction === 'set') {
            ws.send(JSON.stringify({ type: 'important', roomId: currentRoom }));
            return;
          }

          if (ratingAttr) {
            ws.send(JSON.stringify({ type: 'rate', roomId: currentRoom, userId, rating: ratingAttr }));
          }
        };
      });
    }

    function renderLog() {
      if (!logEntries.length) {
        logBox.innerHTML = '<div class="small">Noch keine Einträge</div>';
        return;
      }
      const rows = logEntries.map(e => {
        const time = new Date(e.ts).toLocaleTimeString();
        const action = e.action === 'rating' ? 'Bewertung' : 'Aufruf';
        const rating = e.rating ? e.rating : '';
        return `<tr><td>${time}</td><td>${e.name}</td><td>${action}</td><td>${rating}</td></tr>`;
      }).join('');
      logBox.innerHTML = `<table><thead><tr><th>Zeit</th><th>Name</th><th>Aktion</th><th>Bew.</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    function renderStats() {
      if (!stats.length) {
        statsGrid.innerHTML = '<div class="small">Keine Daten</div>';
        return;
      }
      statsGrid.innerHTML = stats.map(s => {
        const session = s.session || { signals: 0, calls: 0 };
        const total = s.total || { signals: 0, calls: 0, ratings: { '--':0,'-':0,'0':0,'+':0,'++':0 }, toiletSeconds: 0 };
        const ratings = total.ratings || {};
        return `
        <div class="stat-card">
          <h4>${s.name}</h4>
          <div class="small">Stunde: Meldungen ${session.signals || 0} · Aufrufe ${session.calls || 0}</div>
          <div class="small">Gesamt: Meldungen ${total.signals || 0} · Aufrufe ${total.calls || 0}</div>
          <div class="small">Toilette: Stunde ${session.toiletSeconds||0}s · Gesamt ${total.toiletSeconds||0}s</div>
          <div class="small">Bew.: -- ${ratings['--']||0} | - ${ratings['-']||0} | 0 ${ratings['0']||0} | + ${ratings['+']||0} | ++ ${ratings['++']||0}</div>
        </div>`;
      }).join('');
    }

    function renderPoll() {
      if (!poll) {
        pollResultsBox.innerHTML = '<div class="small">Keine aktive Umfrage</div>';
        return;
      }
      pollResultsBox.innerHTML = `
        <div class="q-item">
          <div>${poll.question}</div>
          <div class="q-time">${poll.multiple ? 'Mehrfachauswahl' : 'Einzelauswahl'}</div>
        </div>
        ${poll.options.map(o => `<div class="q-item"><div>${o.text}</div><div class="q-time">${o.count || 0} Stimmen</div></div>`).join('')}
      `;
    }

    function renderThoughts() {
      if (!thoughts.length) {
        thoughtsCloud.innerHTML = '<div class="small">Keine Daten</div>';
        return;
      }
      const max = Math.max(...thoughts.map(t => t.count));
      thoughtsCloud.innerHTML = thoughts.map(t => {
        const size = 12 + Math.round((t.count / max) * 18);
        return `<span class="word" style="font-size:${size}px">${t.text} (${t.count})</span>`;
      }).join(' ');
    }

    function renderHomework() {
      if (!homeworkItems.length) {
        homeworkList.innerHTML = '<div class="small">Keine Hausaufgaben</div>';
        return;
      }
      homeworkList.innerHTML = homeworkItems.map(item => `
        <div class="homework-card">
          <div class="small">Klasse: ${item.className || '-'} · Fach: ${item.subject || 'default'}</div>
          ${item.homework.current ? `<div>Aktuell: ${item.homework.current.text || ''}</div>` : '<div>Aktuell: -</div>'}
          ${item.homework.previous ? `<div class="small">Letzte Stunde: ${item.homework.previous.text || ''}</div>` : ''}
        </div>
      `).join('');
    }

    function renderTemplates() {
      if (!templates.length) {
        templateListBox.innerHTML = '<div class="small">Keine Templates</div>';
        return;
      }
      templateListBox.innerHTML = templates.map(t => `
        <div class="q-item">
          <div>${t.question}</div>
          <div class="small">${t.options.join('; ')}</div>
          <div class="row">
            <button class="ghost" data-activate="${t.id}">Im Raum aktivieren</button>
            <button class="ghost" data-copy="${t.id}">Code kopieren</button>
          </div>
        </div>
      `).join('');
      templateListBox.querySelectorAll('[data-activate]').forEach((btn) => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-activate');
          if (!ws || ws.readyState !== WebSocket.OPEN || !currentRoom) return;
          ws.send(JSON.stringify({ type: 'pollTemplateActivate', roomId: currentRoom, templateId: id }));
        };
      });
      templateListBox.querySelectorAll('[data-copy]').forEach((btn) => {
        btn.onclick = async () => {
          const id = btn.getAttribute('data-copy');
          try {
            await navigator.clipboard.writeText(id);
          } catch (e) {}
        };
      });
    }

    function renderRosterBox() {
      if (!roster.length) {
        rosterBox.innerHTML = '<div class="small">Keine Daten</div>';
        return;
      }
      rosterBox.innerHTML = roster.map(r => `<div class="name ${r.inRoom ? 'in' : ''}">${r.name || r.userId}</div>`).join('');
    }
    function renderQuestions() {
      if (!questions.length) {
        questionsBox.innerHTML = '<div class="small">Keine Fragen</div>';
        questionBanner.style.display = 'none';
        return;
      }
      // Neueste Frage oben
      const sorted = [...questions].sort((a, b) => b.ts - a.ts);
      questionsBox.innerHTML = sorted.map(q => {
        const time = new Date(q.ts).toLocaleTimeString();
        return `<div class="q-item"><div>${q.text}</div><div class="q-time">${time}</div></div>`;
      }).join('');
      const latest = sorted[0];
      questionBannerText.innerHTML = `<div>${latest.text}</div><div class="q-time">${new Date(latest.ts).toLocaleTimeString()}</div>`;
      questionBanner.style.display = 'block';
    }

    function connect() {
      ws = new WebSocket(WS_URL);
      setConnection(false);
      ws.onopen = () => {
        setConnection(true);
        sendInit();
        ws.send(JSON.stringify({ type: 'homeworkListRequest' }));
        ws.send(JSON.stringify({ type: 'pollTemplateList' }));
      };
      ws.onclose = () => {
        setConnection(false);
        setTimeout(connect, 1200);
      };
      ws.onmessage = (ev) => {
        let msg;
        try { msg = JSON.parse(ev.data); } catch { return; }
        handleMessage(msg);
      };
    }

    function sendInit() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({
        type: 'initProfile',
        userId: profile.userId,
        role: profile.role || 'teacher',
        salutation: profile.salutation || 'Herr',
        lastName: profile.lastName || '',
        password: profile.password || '',
        mode: authMode,
      }));
    }

    function sendJoin(roomId) {
      if (!ws || ws.readyState !== WebSocket.OPEN || !roomId) return;
      ws.send(JSON.stringify({ type: 'join', roomId }));
    }

    function handleMessage(msg) {
      if (msg.type === 'profile' && msg.user) {
        profile.userId = msg.user.id;
        profile.salutation = msg.user.salutation || profile.salutation;
        profile.lastName = msg.user.lastName || profile.lastName;
        profile.role = msg.user.role || profile.role;
        profile.teachings = msg.user.teachings || profile.teachings;
        renderProfileInfo();
        renderTeachings();
        localStorage.setItem('meldelisteProfileTeacher', JSON.stringify(profile));
      }
      if (msg.type === 'roomList') {
        rooms = msg.rooms || [];
        renderRooms();
        renderCurrentRoom();
      }
      if (msg.type === 'presence' && msg.roomId === currentRoom) {
        presence = new Map();
        (msg.members || []).forEach((m) => presence.set(m.userId, m));
        renderMembers();
        renderRosterBox();
      }
      if (msg.type === 'ready' && msg.roomId === currentRoom) {
        if (!presence.has(msg.userId)) presence.set(msg.userId, { userId: msg.userId, name: msg.name || 'Unbekannt', ready: true, online: true });
        const p = presence.get(msg.userId);
        p.ready = true;
        p.online = true;
        renderMembers();
        renderRosterBox();
      }
      if (msg.type === 'reset' && msg.roomId === currentRoom) {
        if (presence.has(msg.userId)) {
          presence.get(msg.userId).ready = false;
          renderMembers();
          renderRosterBox();
        }
      }
      if (msg.type === 'resetAll' && msg.roomId === currentRoom) {
        presence.forEach((value) => { value.ready = false; });
        renderMembers();
        renderRosterBox();
      }
      if (msg.type === 'roomClosed' && msg.roomId === currentRoom) {
        currentRoom = null;
        renderCurrentRoom();
      }
      if (msg.type === 'log' && msg.roomId === currentRoom) {
        logEntries = msg.entries || [];
        renderLog();
      }
      if (msg.type === 'stats' && msg.roomId === currentRoom) {
        stats = msg.stats || [];
        renderStats();
      }
      if (msg.type === 'authError') {
        authStatus.textContent = `Fehler: ${msg.reason || 'Anmeldung fehlgeschlagen'}`;
      }
      if (msg.type === 'catalogs') {
        classCatalog = msg.classes || [];
        subjectCatalog = msg.subjects || [];
        renderCatalogs();
      }
      if (msg.type === 'questionList' && msg.roomId === currentRoom) {
        questions = msg.questions || [];
        renderQuestions();
      }
      if (msg.type === 'question' && msg.roomId === currentRoom) {
        questions.push(msg.question);
        renderQuestions();
      }
      if (msg.type === 'poll' && msg.roomId === currentRoom) {
        poll = msg.poll;
        renderPoll();
      }
      if (msg.type === 'thoughtState' && msg.roomId === currentRoom) {
        if (msg.active) {
          thoughts = [];
          renderThoughts();
        }
      }
      if (msg.type === 'thoughtResults' && msg.roomId === currentRoom) {
        thoughts = msg.results || [];
        renderThoughts();
      }
      if (msg.type === 'homework') {
        homeworkItems = homeworkItems.filter((h) => h.className !== msg.className || h.subject !== msg.subject);
        if (msg.homework && msg.homework.text) {
          homeworkItems.push({ className: msg.className, subject: msg.subject, homework: msg.homework });
        }
        renderHomework();
      }
      if (msg.type === 'homeworkList') {
        homeworkItems = msg.items || [];
        renderHomework();
      }
      if (msg.type === 'toilet' && msg.roomId === currentRoom) {
        if (msg.status === 'back') {
          toiletStates.delete(msg.userId);
        } else {
          toiletStates.set(msg.userId, { status: msg.status, start: msg.start || toiletStates.get(msg.userId)?.start || null });
        }
        renderMembers();
      }
      if (msg.type === 'important' && msg.roomId === currentRoom) {
        if (msg.status === 'cleared') {
          const m = presence.get(msg.userId);
          if (m) m.important = false;
        } else if (msg.status === 'pending') {
          const m = presence.get(msg.userId) || {};
          m.important = true;
          presence.set(msg.userId, m);
        }
        renderMembers();
      }
    }

    saveProfileBtn.onclick = () => {
      profile.salutation = salutationInput.value;
      profile.lastName = lastNameInput.value.trim();
      profile.password = passwordInput.value.trim();
      localStorage.setItem('meldelisteProfileTeacher', JSON.stringify(profile));
      renderProfileInfo();
      sendInit();
    };

    modeRegisterBtn.onclick = () => {
      authMode = 'register';
      renderProfileInfo();
    };
    modeLoginBtn.onclick = () => {
      authMode = 'login';
      renderProfileInfo();
    };

    logoutBtn.onclick = () => {
      localStorage.removeItem('meldelisteProfileTeacher');
      profile = { role: 'teacher', userId: null, salutation: 'Herr', lastName: '', password: '' };
      salutationInput.value = profile.salutation;
      lastNameInput.value = '';
      passwordInput.value = '';
      renderProfileInfo();
      authStatus.textContent = 'Profil gelöscht';
    };

    createRoomBtn.onclick = () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      const name = roomNameInput.value.trim() || 'Raum';
      const className = roomClassInput.value;
      const subject = roomSubjectInput.value || 'default';
      if (!className) return;
      ws.send(JSON.stringify({ type: 'roomCreate', name, className, subject }));
      roomNameInput.value = '';
    };

    closeRoomBtn.onclick = () => {
      if (!currentRoom || !ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: 'roomClose', roomId: currentRoom }));
    };

    addClassBtn.onclick = () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      const cls = newClassInput.value.trim();
      if (!cls) return;
      ws.send(JSON.stringify({ type: 'createClass', className: cls }));
      newClassInput.value = '';
    };

    addSubjectBtn.onclick = () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      const subj = newSubjectInput.value.trim();
      if (!subj) return;
      ws.send(JSON.stringify({ type: 'createSubject', subject: subj }));
      newSubjectInput.value = '';
    };

    addTeachingBtn.onclick = () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      const cls = teachClassSelect.value;
      const subj = teachSubjectSelect.value;
      if (!cls || !subj) return;
      ws.send(JSON.stringify({ type: 'addTeaching', className: cls, subject: subj }));
    };

    questionClose.onclick = () => {
      questionBanner.style.display = 'none';
    };

    createPollBtn.onclick = () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      const question = pollQuestionInput.value.trim();
      const opts = pollOptionsInput.value.split(';').map(s => s.trim()).filter(Boolean);
      const multiple = pollMultipleInput.checked;
      if (!question || opts.length < 2) return;
      ws.send(JSON.stringify({ type: 'pollCreate', roomId: currentRoom, question, options: opts, multiple }));
      pollQuestionInput.value = '';
      pollOptionsInput.value = '';
      pollMultipleInput.checked = false;
    };

    startThoughtsBtn.onclick = () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: 'thoughtStart', roomId: currentRoom }));
      thoughts = [];
      renderThoughts();
    };

    endThoughtsBtn.onclick = () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: 'thoughtEnd', roomId: currentRoom }));
    };

    sendHomeworkBtn.onclick = () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      const text = homeworkText.value.trim();
      if (!text || !currentRoom) return;
      const room = rooms.find(r => r.id === currentRoom);
      if (!room) return;
      ws.send(JSON.stringify({ type: 'homeworkSet', className: room.className, subject: room.subject || 'default', text }));
      homeworkText.value = '';
    };

    // Beim Verbindungsaufbau Hausaufgabenliste holen
    const originalConnect = connect;
    // connect already defined; we append to onopen handler via wrapping would be messy; instead we add after init via sendInit

    const saved = localStorage.getItem('meldelisteProfileTeacher');
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        profile = { ...profile, ...parsed };
        salutationInput.value = profile.salutation || 'Herr';
        lastNameInput.value = profile.lastName || '';
        passwordInput.value = profile.password || '';
        renderProfileInfo();
      } catch (e) {}
    }

    renderProfileInfo();
    setInterval(() => {
      if (currentRoom) renderMembers();
    }, 10000);
    connect();
  </script>
</body>
</html>
    .roster { display:grid; grid-template-columns: repeat(auto-fill,minmax(160px,1fr)); gap:8px; margin-top:10px; }
    .roster .name { padding:8px; border:2px solid #f45b69; border-radius:10px; }
    .roster .name.in { border-color:#36c38c; }
    <div class="panel">
      <h2>Anwesenheit</h2>
      <div class="roster" id="rosterBox"><div class="small">Keine Daten</div></div>
    </div>
