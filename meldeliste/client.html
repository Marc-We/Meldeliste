<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meldeliste – Schüler</title>
  <style>
    :root {
      --bg: #0a0c10;
      --panel: #111522;
      --card: #0f172a;
      --accent: #36c38c;
      --muted: #7a8499;
      --text: #e7edff;
      --danger: #f45b69;
      --line: #1f2943;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: radial-gradient(120% 80% at 15% 20%, #162240, #0a0c10 60%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .layout { width: min(900px, 100%); display: grid; gap: 16px; }
    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 14px 40px rgba(0,0,0,0.35);
    }
    h1 { margin: 0 0 8px; }
    h2 { margin: 0 0 10px; font-size: 19px; }
    label { display: block; margin-top: 10px; color: var(--muted); font-size: 14px; }
    input, select {
      width: 100%;
      margin-top: 6px;
      padding: 11px 12px;
      border-radius: 10px;
      border: 1px solid #24304c;
      background: #0c1424;
      color: var(--text);
      font-size: 15px;
    }
    button {
      padding: 12px 16px;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      transition: transform 0.08s ease, filter 0.12s ease;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    button:hover:not(:disabled) { transform: translateY(-1px); filter: brightness(1.05); }
    .primary { background: var(--accent); color: #06110b; }
    .ghost { background: transparent; color: var(--text); border: 1px solid #2b3652; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .status {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 12px; border-radius: 999px; border: 1px solid var(--line);
      background: rgba(255,255,255,0.04); font-weight: 600; font-size: 14px;
    }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--danger); }
    .dot.ok { background: var(--accent); box-shadow: 0 0 10px rgba(54,195,140,0.6); }
    .pill {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 10px; border-radius: 999px; border: 1px solid #27324f;
      background: rgba(255,255,255,0.03); font-size: 13px;
    }
    .called { padding: 10px; border: 1px solid rgba(54,195,140,0.4); background: rgba(54,195,140,0.08); border-radius: 10px; margin-top: 10px; display: none; cursor: pointer; }
    .called.show { display: block; }
    .info { padding: 10px; border: 1px solid rgba(155,89,182,0.4); background: rgba(155,89,182,0.08); border-radius: 10px; margin-top: 10px; display: none; cursor: pointer; }
    .info.show { display: block; }
    .back-active {
      background: #6e3fa5;
      border: 1px solid #6e3fa5;
      color: #fff;
    }
    .statbox { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap: 10px; }
    .card { background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 12px; }
    .card h3 { margin: 0 0 6px; font-size: 14px; color: var(--muted); }
    .card .num { font-size: 24px; font-weight: 800; }
    .log { max-height: 240px; overflow: auto; margin-top: 10px; }
    .log table { width: 100%; border-collapse: collapse; font-size: 14px; color: var(--text); }
    .log th, .log td { padding: 8px 6px; border-bottom: 1px solid #1c2440; text-align: left; }
    .empty { color: var(--muted); font-size: 14px; }
    .daily { font-size: 13px; color: var(--muted); margin-top: 8px; }
    .roster { display:grid; grid-template-columns: repeat(auto-fill,minmax(160px,1fr)); gap:8px; margin-top:10px; }
    .roster .name { padding:8px; border:2px solid #f45b69; border-radius:10px; }
    .roster .name.in { border-color:#36c38c; }
  </style>
</head>
<body>
  <div class="layout">
    <div class="row" style="align-items:center; justify-content: space-between;">
      <h1>Schüler-Client</h1>
      <div class="status"><div class="dot" id="dot"></div><span id="connText">Verbinde...</span></div>
    </div>

    <div class="panel">
      <h2>Gedankenrunde</h2>
      <div id="thoughtState" class="small">Nicht aktiv</div>
    </div>

    <div class="panel" id="rosterPanel" style="display:none">
      <h2>Anwesenheit</h2>
      <div class="roster" id="rosterBox"><div class="empty">Keine Daten</div></div>
    </div>

    <div class="panel">
      <h2>Profil</h2>
      <div class="row">
        <label style="flex:1">
          Vorname
          <input id="firstName" placeholder="Dein Vorname">
        </label>
        <label style="flex:1">
          Nachname
          <input id="lastName" placeholder="Dein Nachname">
        </label>
        <label style="width:160px">
          Klasse
          <input id="className" placeholder="z. B. 10A">
        </label>
        <label style="width:160px">
          Passwort
          <input id="password" type="password" placeholder="Passwort">
        </label>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="saveProfile" class="ghost">Speichern & ${'{'}authMode{'}'}</button>
      </div>
      <div class="pill" id="profileInfo">Noch kein Profil gespeichert</div>
      <div class="row" style="margin-top:6px">
        <button id="modeRegister" class="ghost" style="flex:1">Registrieren</button>
        <button id="modeLogin" class="ghost" style="flex:1">Anmelden</button>
        <button id="logout" class="ghost" style="flex:1">Profil löschen</button>
      </div>
      <div class="pill" id="authStatus"></div>
    </div>

      <div class="panel">
        <h2>Raum & Meldung</h2>
        <label>
          Aktiver Raum
          <select id="roomSelect"></select>
      </label>
      <div class="row" style="margin-top:12px">
        <button id="readyBtn" class="primary" disabled>Ich melde mich</button>
        <button id="withdrawBtn" class="ghost" disabled>Meldung zurücknehmen</button>
        <button id="toiletBtn" class="ghost" disabled style="color:#fff; background:#6e3fa5; border-color:#6e3fa5;">Toilette</button>
        <button id="backBtn" class="ghost" disabled>Ich bin zurück</button>
        <button id="importantBtn" class="ghost" disabled style="color:#fff; background:#e74c3c; border-color:#e74c3c;">Wichtig</button>
        <button id="leaveBtn" class="ghost" disabled>Raum verlassen</button>
      </div>
      <div class="called" id="calledBox" title="Klicken zum Schließen">Du wurdest aufgerufen – bitte melden!</div>
      <div class="info" id="toiletInfo" title="Klicken zum Schließen">Toiletten-Erlaubnis: Laufzeit 0s</div>
      <div class="info" id="importantInfo" title="Klicken zum Schließen" style="border-color: rgba(231,76,60,0.4); background: rgba(231,76,60,0.08);">Wichtig gemeldet</div>
      <div style="margin-top:12px">
        <label>Frage (anonym)</label>
        <textarea id="questionText" rows="3" style="width:100%; padding:10px; border-radius:10px; border:1px solid #24304c; background:#0c1424; color:var(--text);"></textarea>
        <button id="sendQuestion" class="ghost" style="margin-top:6px">Frage senden</button>
      </div>
    </div>

    <div class="panel">
      <h2>Deine Stunde</h2>
      <div class="statbox">
        <div class="card">
          <h3>Meldungen (Stunde / Gesamt)</h3>
          <div class="num" id="countSignals">0 / 0</div>
        </div>
        <div class="card">
          <h3>Aufrufe (Stunde / Gesamt)</h3>
          <div class="num" id="countCalls">0 / 0</div>
        </div>
        <div class="card">
          <h3>Toilette (Sek., Stunde / Gesamt)</h3>
          <div class="num" id="countToilet">0 / 0</div>
        </div>
      </div>
      <div class="daily" id="dailyStats"></div>
      <div class="log" id="logBox">
        <div class="empty">Noch keine Einträge</div>
      </div>
    </div>

    <div class="panel" id="pollPanel">
      <h2>Umfrage</h2>
      <div id="pollContainer"><div class="empty">Keine Umfrage</div></div>
      <button id="pollVote" class="ghost" style="margin-top:8px">Abstimmen</button>
    </div>
  </div>

  <div class="layout">
    <div class="panel" id="homeworkPanel" style="display:none">
      <h2>Hausaufgaben</h2>
      <div id="homeworkList"><div class="empty">Keine Hausaufgaben</div></div>
    </div>
  </div>

  <script>
    const host = location.hostname || 'localhost';
    const WS_URL = `${location.protocol === 'https:' ? 'wss' : 'ws'}://${host}:3000`;

    const dot = document.getElementById('dot');
    const connText = document.getElementById('connText');
    const firstNameInput = document.getElementById('firstName');
    const lastNameInput = document.getElementById('lastName');
    const classInput = document.getElementById('className');
    const passwordInput = document.getElementById('password');
    const saveProfileBtn = document.getElementById('saveProfile');
    const profileInfo = document.getElementById('profileInfo');
    const modeRegisterBtn = document.getElementById('modeRegister');
    const modeLoginBtn = document.getElementById('modeLogin');
    const logoutBtn = document.getElementById('logout');
    const authStatus = document.getElementById('authStatus');
    const roomSelect = document.getElementById('roomSelect');
    const readyBtn = document.getElementById('readyBtn');
    const withdrawBtn = document.getElementById('withdrawBtn');
    const toiletBtn = document.getElementById('toiletBtn');
    const backBtn = document.getElementById('backBtn');
    const importantBtn = document.getElementById('importantBtn');
    const leaveBtn = document.getElementById('leaveBtn');
    const calledBox = document.getElementById('calledBox');
    const toiletInfo = document.getElementById('toiletInfo');
    const importantInfo = document.getElementById('importantInfo');
    const questionText = document.getElementById('questionText');
    const sendQuestionBtn = document.getElementById('sendQuestion');
    const countSignals = document.getElementById('countSignals');
    const countCalls = document.getElementById('countCalls');
    const countToilet = document.getElementById('countToilet');
    const dailyStatsEl = document.getElementById('dailyStats');
    const logBox = document.getElementById('logBox');
    const homeworkPanel = document.getElementById('homeworkPanel');
    const homeworkList = document.getElementById('homeworkList');
    const pollBox = document.getElementById('pollPanel');
    const pollContainer = document.getElementById('pollContainer');
    const pollVoteBtn = document.getElementById('pollVote');
    const thoughtState = document.getElementById('thoughtState');
    const rosterPanel = document.getElementById('rosterPanel');
    const rosterBox = document.getElementById('rosterBox');

    let ws = null;
    let profile = { role: 'student', userId: null, firstName: '', lastName: '', className: '', password: '' };
    let authMode = 'register'; // 'login' or 'register'

    function updateAuthModeButtons() {
      modeRegisterBtn.classList.toggle('primary', authMode === 'register');
      modeLoginBtn.classList.toggle('primary', authMode === 'login');
      modeRegisterBtn.classList.toggle('ghost', authMode !== 'register');
      modeLoginBtn.classList.toggle('ghost', authMode !== 'login');
    }
    let rooms = [];
    let currentRoom = null;
    let myLog = [];
    let myStats = { session: { signals: 0, calls: 0, toiletSeconds: 0 }, total: { signals: 0, calls: 0, toiletSeconds: 0 }, daily: {} };
    let toiletState = { status: 'idle', start: null };
    let importantState = false;
    let poll = null;
    let pollSelection = [];
    let thoughtActive = false;
    let pollCollapsed = false;
    let homeworkItems = [];
    let roster = [];

    function renderHomework() {
      if (!homeworkItems.length) {
        homeworkList.innerHTML = '<div class="empty">Keine Hausaufgaben</div>';
        homeworkPanel.style.display = 'none';
        return;
      }
      homeworkPanel.style.display = 'block';
      homeworkList.innerHTML = homeworkItems.map(item => {
        const hw = item.homework || {};
        const cur = hw.current?.text || '';
        return `<div class="card"><h3 style="margin:0 0 4px;">${item.subject || 'Fach'}</h3><div class="small">${item.className || ''}</div><div>${cur}</div></div>`;
      }).join('');
    }

    function setConnection(ok) {
      dot.classList.toggle('ok', ok);
      connText.textContent = ok ? 'Verbunden' : 'Getrennt';
    }

    function renderRooms() {
      roomSelect.innerHTML = '';
      const activeRooms = rooms
        .filter(r => r.active !== false)
        .filter(r => !profile.className || !r.className || r.className === profile.className);
      if (activeRooms.length === 0) {
        roomSelect.innerHTML = '<option value="">Keine aktiven Räume</option>';
        readyBtn.disabled = true;
        leaveBtn.disabled = true;
        withdrawBtn.disabled = true;
        toiletBtn.disabled = true;
        backBtn.disabled = true;
        importantBtn.disabled = true;
        return;
      }
      activeRooms.forEach((room) => {
        const opt = document.createElement('option');
        opt.value = room.id;
        opt.textContent = `${room.name} (${room.subject})`;
        roomSelect.appendChild(opt);
      });
      if (currentRoom) {
        roomSelect.value = currentRoom;
      } else {
        roomSelect.selectedIndex = 0;
        currentRoom = roomSelect.value || null;
        if (currentRoom) sendJoin(currentRoom);
      }
      readyBtn.disabled = !currentRoom;
      leaveBtn.disabled = !currentRoom;
      toiletBtn.disabled = !currentRoom;
      backBtn.disabled = !currentRoom || toiletState.status !== 'allowed';
      importantBtn.disabled = !currentRoom;
      sendQuestionBtn.disabled = !currentRoom;
    }

    function renderProfileInfo() {
      if (!profile.userId) {
        profileInfo.textContent = 'Noch kein Profil gespeichert';
      } else {
        profileInfo.textContent = `Eingeloggt als ${profile.firstName || ''} ${profile.lastName || ''} (Klasse ${profile.className || '-'})`;
      }
      authStatus.textContent = authMode === 'register' ? 'Registrierungsmodus' : 'Anmeldemodus';
      updateAuthModeButtons();
    }

    function renderCalled(on) {
      calledBox.classList.toggle('show', on);
    }

    function renderToilet(on, text) {
      toiletInfo.classList.toggle('show', on);
      if (text) toiletInfo.textContent = text;
      const isAllowed = toiletState.status === 'allowed';
      backBtn.disabled = !isAllowed;
      backBtn.classList.toggle('back-active', isAllowed);
      const disableOthers = isAllowed || toiletState.status === 'pending';
      if (disableOthers) {
        readyBtn.disabled = true;
        withdrawBtn.disabled = true;
        toiletBtn.disabled = true;
        leaveBtn.disabled = true;
        importantBtn.disabled = true;
      } else if (currentRoom) {
        readyBtn.disabled = false;
        withdrawBtn.disabled = true;
        toiletBtn.disabled = false;
        leaveBtn.disabled = false;
        importantBtn.disabled = false;
      }
    }
    function renderImportant(on) {
      importantState = on;
      importantInfo.classList.toggle('show', on);
      if (on) {
        importantInfo.textContent = 'Wichtig gemeldet';
      }
    }

    function renderLog() {
      if (!myLog.length) {
        logBox.innerHTML = '<div class="empty">Noch keine Einträge</div>';
        return;
      }
      const rows = myLog.map(entry => {
        const time = new Date(entry.ts).toLocaleTimeString();
        return `<tr><td>${time}</td><td>${entry.action === 'called' ? 'Aufruf' : ''}</td></tr>`;
      }).join('');
      logBox.innerHTML = `<table><thead><tr><th>Zeit</th><th>Aktion</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    function renderStats() {
      const session = myStats.session || { signals: 0, calls: 0 };
      const total = myStats.total || { signals: 0, calls: 0 };
      countSignals.textContent = `${session.signals || 0} / ${total.signals || 0}`;
      countCalls.textContent = `${session.calls || 0} / ${total.calls || 0}`;
      const sessionToilet = myStats.session?.toiletSeconds || 0;
      const totalToilet = myStats.total?.toiletSeconds || 0;
      countToilet.textContent = `${sessionToilet} / ${totalToilet}`;
      const daily = myStats.daily || {};
      const days = Object.keys(daily).sort().slice(-5);
      if (!days.length) {
        dailyStatsEl.textContent = 'Keine Tagesdaten';
      } else {
        dailyStatsEl.textContent = 'Letzte Tage: ' + days.map(d => `${d}: M ${daily[d].signals||0} · A ${daily[d].calls||0} · T ${daily[d].toiletSeconds||0}s`).join(' | ');
      }
    }

    function renderPoll() {
      if (!poll) {
        pollContainer.innerHTML = '<div class="empty">Keine Umfrage</div>';
        pollVoteBtn.disabled = true;
        pollBox.style.display = 'none';
        return;
      }
      pollBox.style.display = 'block';
      pollCollapsed = false;
      pollContainer.innerHTML = `
        <div class="card">
          <h3 style="margin:0 0 6px;">${poll.question}</h3>
          ${poll.options.map(opt => {
            const inputType = poll.multiple ? 'checkbox' : 'radio';
            const checked = pollSelection.includes(opt.id) ? 'checked' : '';
            return `<label style="display:flex;align-items:center;gap:8px;margin:4px 0;"><input type="${inputType}" name="pollopt" value="${opt.id}" ${checked}>${opt.text}</label>`;
          }).join('')}
        </div>
      `;
      pollVoteBtn.disabled = false;
    }

    function renderThoughtState() {
      if (thoughtActive) {
        thoughtState.textContent = 'Gedankenrunde aktiv – schreibe deine Gedanken und sende sie.';
      } else {
        thoughtState.textContent = 'Nicht aktiv';
      }
    }

    function connect() {
      ws = new WebSocket(WS_URL);
      setConnection(false);
      ws.onopen = () => {
        setConnection(true);
        sendInit();
        // nach Login Hausaufgabenliste anfragen
        ws.send(JSON.stringify({ type: 'homeworkListRequest' }));
      };
      ws.onclose = () => {
        setConnection(false);
        setTimeout(connect, 1200);
      };
      ws.onmessage = (ev) => {
        let msg;
        try { msg = JSON.parse(ev.data); } catch { return; }
        handleMessage(msg);
      };
    }

    function sendInit() {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({
        type: 'initProfile',
        userId: profile.userId,
        role: 'student',
        firstName: profile.firstName || '',
        lastName: profile.lastName || '',
        className: profile.className || '',
        password: profile.password || '',
        mode: authMode,
      }));
    }

    function sendJoin(roomId) {
      if (!ws || ws.readyState !== WebSocket.OPEN || !roomId) return;
      ws.send(JSON.stringify({ type: 'join', roomId }));
    }

    function handleMessage(msg) {
      if (msg.type === 'profile' && msg.user) {
        profile.userId = msg.user.id;
        profile.firstName = msg.user.firstName || profile.firstName;
        profile.lastName = msg.user.lastName || profile.lastName;
        profile.className = msg.user.className || profile.className;
        renderProfileInfo();
        localStorage.setItem('meldelisteProfile', JSON.stringify(profile));
      }
      if (msg.type === 'roomList') {
        rooms = msg.rooms || [];
        renderRooms();
      }
      if (msg.type === 'called') {
        renderCalled(true);
        readyBtn.disabled = false;
        withdrawBtn.disabled = true;
      }
      if (msg.type === 'reset' && msg.userId === profile.userId) {
        renderCalled(false);
        readyBtn.disabled = false;
        withdrawBtn.disabled = true;
      }
      if (msg.type === 'resetAll' && msg.roomId === currentRoom) {
        renderCalled(false);
        readyBtn.disabled = false;
        withdrawBtn.disabled = true;
      }
      if (msg.type === 'myLog') {
        myLog = msg.entries || [];
        renderLog();
      }
      if (msg.type === 'myStats') {
        myStats = { session: msg.session || {}, total: msg.total || {}, daily: msg.daily || {} };
        renderStats();
      }
      if (msg.type === 'authError') {
        authStatus.textContent = `Fehler: ${msg.reason || 'Anmeldung fehlgeschlagen'}`;
      }
      if (msg.type === 'toiletAllowed') {
        toiletState = { status: 'allowed', start: msg.start || Date.now() };
        renderToilet(true, 'Toiletten-Erlaubnis: läuft...');
      }
      if (msg.type === 'toilet') {
        if (msg.userId !== profile.userId) return;
        if (msg.status === 'allowed') {
          toiletState = { status: 'allowed', start: msg.start || Date.now() };
          renderToilet(true, 'Toiletten-Erlaubnis: läuft...');
        } else if (msg.status === 'back') {
          toiletState = { status: 'idle', start: null };
          renderToilet(false);
        } else if (msg.status === 'pending') {
          toiletState = { status: 'pending', start: null };
          renderToilet(true, 'Warte auf Erlaubnis...');
        }
      }
      if (msg.type === 'important') {
        if (msg.userId !== profile.userId) return;
        if (msg.status === 'pending') {
          renderImportant(true);
        } else if (msg.status === 'cleared') {
          renderImportant(false);
        }
      }
      if (msg.type === 'poll' && msg.roomId === currentRoom) {
        poll = msg.poll;
        pollSelection = [];
        renderPoll();
      }
      if (msg.type === 'thoughtState' && msg.roomId === currentRoom) {
        thoughtActive = Boolean(msg.active);
        renderThoughtState();
      }
      if (msg.type === 'thoughtResults' && msg.roomId === currentRoom) {
        thoughtActive = false;
        renderThoughtState();
      }
      if (msg.type === 'homework') {
        if (profile.className && msg.className && msg.className !== profile.className) return;
        homeworkItems = homeworkItems.filter((h) => h.className !== msg.className || h.subject !== msg.subject);
        if (msg.homework && msg.homework.current && msg.homework.current.text) {
          homeworkItems.push({ className: msg.className, subject: msg.subject, homework: msg.homework });
        }
        renderHomework();
      }
      if (msg.type === 'homeworkList') {
        homeworkItems = (msg.items || []).filter((it) => it.homework && it.homework.current && it.homework.current.text);
        renderHomework();
      }
      if (msg.type === 'roster' && msg.roomId === currentRoom) {
        roster = msg.roster || [];
        renderRoster();
      }
    }

    saveProfileBtn.onclick = () => {
      profile.firstName = firstNameInput.value.trim();
      profile.lastName = lastNameInput.value.trim();
      profile.className = classInput.value.trim();
      profile.password = passwordInput.value.trim();
      renderProfileInfo();
      localStorage.setItem('meldelisteProfile', JSON.stringify(profile));
      sendInit();
    };

    modeRegisterBtn.onclick = () => {
      authMode = 'register';
      renderProfileInfo();
    };
    modeLoginBtn.onclick = () => {
      authMode = 'login';
      renderProfileInfo();
    };

    logoutBtn.onclick = () => {
      localStorage.removeItem('meldelisteProfile');
      profile = { role: 'student', userId: null, firstName: '', lastName: '', className: '', password: '' };
      firstNameInput.value = '';
      lastNameInput.value = '';
      classInput.value = '';
      passwordInput.value = '';
      renderProfileInfo();
      authStatus.textContent = 'Profil gelöscht';
    };

    roomSelect.onchange = () => {
      currentRoom = roomSelect.value || null;
      if (currentRoom) {
        sendJoin(currentRoom);
        readyBtn.disabled = false;
        leaveBtn.disabled = false;
        withdrawBtn.disabled = true;
        toiletBtn.disabled = false;
        backBtn.disabled = true;
        backBtn.classList.remove('back-active');
        renderCalled(false);
        renderToilet(false);
      } else {
        readyBtn.disabled = true;
        leaveBtn.disabled = true;
        withdrawBtn.disabled = true;
        toiletBtn.disabled = true;
        backBtn.disabled = true;
        backBtn.classList.remove('back-active');
      }
    };

    readyBtn.onclick = () => {
      if (!currentRoom || !ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: 'ready', roomId: currentRoom }));
      readyBtn.disabled = true;
      withdrawBtn.disabled = false;
      toiletBtn.disabled = false;
    };

    withdrawBtn.onclick = () => {
      if (!currentRoom || !ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: 'withdraw', roomId: currentRoom }));
      readyBtn.disabled = false;
      withdrawBtn.disabled = true;
    };

    toiletBtn.onclick = () => {
      if (!currentRoom || !ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: 'toilet', roomId: currentRoom }));
      toiletState = { status: 'pending', start: null };
      renderToilet(true, 'Warte auf Erlaubnis...');
    };

    backBtn.onclick = () => {
      if (!currentRoom || !ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: 'toiletBack', roomId: currentRoom }));
      toiletState = { status: 'idle', start: null };
      renderToilet(false);
    };

    importantBtn.onclick = () => {
      if (!currentRoom || !ws || ws.readyState !== WebSocket.OPEN) return;
      if (importantState) {
        ws.send(JSON.stringify({ type: 'importantWithdraw', roomId: currentRoom }));
        renderImportant(false);
      } else {
        ws.send(JSON.stringify({ type: 'important', roomId: currentRoom }));
        renderImportant(true);
      }
    };

    sendQuestionBtn.onclick = () => {
      if (!currentRoom || !ws || ws.readyState !== WebSocket.OPEN) return;
      const text = questionText.value.trim();
      if (!text) return;
      if (thoughtActive) {
        ws.send(JSON.stringify({ type: 'thoughtSubmit', roomId: currentRoom, text }));
      } else {
        ws.send(JSON.stringify({ type: 'questionSubmit', roomId: currentRoom, text }));
      }
      questionText.value = '';
    };

    pollVoteBtn.onclick = () => {
      if (!currentRoom || !ws || ws.readyState !== WebSocket.OPEN) return;
      const inputs = pollContainer.querySelectorAll('input[name="pollopt"]');
      const selected = [];
      inputs.forEach((inp) => {
        if (inp.checked) selected.push(inp.value);
      });
      if (!selected.length) return;
      ws.send(JSON.stringify({ type: 'pollVote', roomId: currentRoom, options: selected }));
      pollSelection = selected;
      pollCollapsed = true;
      pollContainer.innerHTML = '<div class="empty">Abgegeben</div>';
      pollVoteBtn.disabled = true;
    };

    // Gedankenrunde: Schüler sendet Text über Fragefeld (questionText) – optional separater Button?
    questionText.placeholder = 'Deine Frage oder Gedanken';

    leaveBtn.onclick = () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify({ type: 'leave' }));
      currentRoom = null;
      roomSelect.value = '';
      readyBtn.disabled = true;
      leaveBtn.disabled = true;
      withdrawBtn.disabled = true;
      toiletBtn.disabled = true;
      backBtn.disabled = true;
      backBtn.classList.remove('back-active');
      renderCalled(false);
      renderToilet(false);
      renderImportant(false);
    };

    calledBox.onclick = () => {
      renderCalled(false);
    };

    const saved = localStorage.getItem('meldelisteProfile');
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        profile = { ...profile, ...parsed, role: 'student' };
        firstNameInput.value = profile.firstName || '';
        lastNameInput.value = profile.lastName || '';
        classInput.value = profile.className || '';
        passwordInput.value = profile.password || '';
        renderProfileInfo();
      } catch (e) {}
    }

    connect();
  </script>
</body>
</html>
